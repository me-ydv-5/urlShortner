<!DOCTYPE html>
<html>
<head>
	<title>URL Shortner</title>
      <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <link rel="stylesheet" href="css/main.css">
      <link rel="shortcut icon" type="image/png" href="/images/favicon.png"/>
</head>

<body style="background-color: #b3e5fc;">

	<div class="left_side">
		<font size="+40" style="position: absolute; margin-top: 187px; margin-left: 2%">
			goo.gl got shut down but we're still up! We ain't going gloomy anytime sooner.
		</font>
	</div>	
	<div class="right_side">
    	<form id="form" action="javascript:submitURL();">
	    	<div class="row">
	    	  	<div class="input-field col s12" style="width: 520px;">
	    	    	<input id="url" type="text">
	    	    	<label for="url">Enter long URL</label>
	    	  	</div>
	    	</div>

	    	<div style="padding-top: 20px; color: #000000;">
				<button class="btn waves-effect waves-light" style="width: 130px;" id="button">
				Shorten it!
				</button>
				<script type="text/javascript">
					function submitURL() {
						argument = document.getElementById('url').value
						console.log("argumentsent " + argument)
						var init = {
							method: 'POST',
							headers: {
								'Content-Type': "application/json"
							},
							body: JSON.stringify({'url': argument})
						}

						fetch('/generate-short-url', init)
						  	.then(data => data.json())
						  	.then(data => {
						  		console.log(data)
						  		updateTable();
						  	})
						  	.catch(error => console.error(error));
					}

				</script>
			</div>

    	</form>
	        
		<div class="vertical-menu" id="style-1">
	      	<table class="centered responsive-table" id="table">
	        	<thead id="thead">
	          		<tr>
						<th>Shortened URL</th>
						<th>Long URL</th>
						<th>Hit Rate</th>
						<th>
							Delete
						</th>
	          		</tr>
	        	</thead>
	        	<tbody id = "tBody">

				<script>
					window.onload = updateTable();

					function delCall(data) {
						fetch(data, {method: 'DELETE'})
							.then(res => {
								console.log("deleted the entry from frontend");
								updateTable();
							})
							.catch(err => console.log(err));
					}
					
				  	// setInterval("updateTable()",5000);
				  	function updateTable() {
						console.log('Updating the table..')
						fetch('/list')
							.then(incomingData => incomingData.json())
						  	.then(incomingData => {
						  		incomingData.sort((a, b) => {
						  			return a.hitrate > b.hitrate ? -1 : 1
						  		})
						  		console.log(incomingData)

						  		var table = document.getElementById("tBody");
						  		table.innerHTML = "";
						  		for (var i = 0; i <= incomingData.length - 1; i++) {
									var data = incomingData[i]['shorturl']
									var url = incomingData[i]['longurl']

						  			var row = table.insertRow(i);
									var cell1 = row.insertCell(0);
									var cell2 = row.insertCell(1);
									var cell3 = row.insertCell(2);
									var cell4 = row.insertCell(3);

									var short = 	`<a href=/${data} `
													+"target=\"_blank\">"
													+`${data}</a>`
									if(url.length > 20)
										url = url.substring(0, 20) + "...";
									cell1.innerHTML = short
									cell2.innerHTML = url
									cell3.innerHTML = incomingData[i]['hitrate']

									var delCall = 
									"<a href=\"#\" " +  
									"onClick=\"jacascript:delCall(" + 
									`'${data}'` + 
									");\">" + 
									"<i class=\"material-icons\">delete_forever</i></a>";
									cell4.innerHTML = delCall;
						  		}
						  	})
						  	.catch(error => console.error(error));
					}
				</script>
	        	</tbody>
	      	</table>
	  	</div>	
	</div>

<script type="text/javascript" src="js/materialize.min.js"></script>
</body>
</html>